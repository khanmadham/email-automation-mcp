# AI Email Automation System

Production-ready email automation system built with Node.js, Gmail API, and OpenAI that automatically reads incoming emails, filters them based on rules, and generates intelligent responses.

---

## ‚ú® Key Features

- **Gmail OAuth2 Integration** - Secure authentication with Google Workspace
- **AI-Powered Responses** - Generate personalized emails using OpenAI
- **Rule-Based Filtering** - Flexible configuration for email matching logic
- **Automated Scheduling** - Process emails on configurable intervals using cron
- **Detailed Logging** - Monitor system activity with Winston logging
- **Production Ready** - Modular architecture with error handling and graceful shutdown

---

## üöÄ Quick Start

### Prerequisites

- Node.js 16+
- npm or yarn
- OpenAI API key
- Google Cloud project with Gmail API enabled

### Installation

```bash
# Clone the repository
git clone <repository-url>
cd email-automation

# Install dependencies
npm install

# Copy environment template
cp .env.example .env
```

### Setup Gmail Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project and enable the Gmail API
3. Create OAuth 2.0 credentials (Web application type)
4. Download the JSON file and extract credentials:
   - `GMAIL_CLIENT_ID`
   - `GMAIL_CLIENT_SECRET`

5. Add credentials to `.env`:
```env
GMAIL_CLIENT_ID=your_client_id
GMAIL_CLIENT_SECRET=your_client_secret
OPENAI_API_KEY=your_openai_api_key
```

6. Run the authentication flow:
```bash
npm run setup
```

This generates a `GOOGLE_TOKEN_JSON` that you'll add to `.env`.

### Start the System

```bash
npm start
```

The system will initialize and begin processing emails at the configured interval.

---

## üîå Connecting Claude Desktop (MCP)

The server exposes a **Streamable HTTP MCP transport** at `http://localhost:3000/mcp`.

### Step 1 ‚Äî Start the server

```bash
npm start
```

### Step 2 ‚Äî Add to Claude Desktop

Open **Claude Desktop ‚Üí Settings ‚Üí Developer ‚Üí Edit Config** and add:

```json
{
  "mcpServers": {
    "email-automation": {
      "url": "http://localhost:3000/mcp"
    }
  }
}
```

Save the file and **restart Claude Desktop**. The MCP server will appear in Claude's tools panel.

> **Note:** If you were previously seeing *"There was an error connecting to the MCP server"*, this was because the server only supported stdio transport and had no HTTP MCP endpoint. The `/mcp` HTTP endpoint has now been added.

---

## üèóÔ∏è Architecture

### Processing Pipeline

```
1. Scheduler triggers every N minutes
                    ‚Üì
2. Fetch unread emails from Gmail
                    ‚Üì
3. For each email, apply filtering rules
                    ‚Üì
4. If email matches rules:
   - Extract sender information
   - Send to OpenAI for response generation
   - Generate personalized reply
                    ‚Üì
5. Send reply to original sender
                    ‚Üì
6. Mark as read and label "AutoReplied"
```

### Project Structure

```
email-automation/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ rules.json              # Email filtering rules
‚îÇ   ‚îî‚îÄ‚îÄ settings.json           # Application settings
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ gmail/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js             # OAuth 2.0 authentication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emailService.js     # Gmail API operations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ setup.js            # Authentication flow
‚îÇ   ‚îú‚îÄ‚îÄ filters/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ engine.js           # Rule evaluation engine
‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ openai.js           # OpenAI integration
‚îÇ   ‚îú‚îÄ‚îÄ processor/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ emailProcessor.js   # Email processing pipeline
‚îÇ   ‚îú‚îÄ‚îÄ scheduler/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cronScheduler.js    # Cron scheduling
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.js           # Winston logging setup
‚îÇ   ‚îî‚îÄ‚îÄ index.js                # Application entry point
‚îú‚îÄ‚îÄ logs/                       # Application logs (auto-created)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ .env                        # Environment variables
‚îú‚îÄ‚îÄ .env.example                # Environment template
‚îî‚îÄ‚îÄ README.md
```

---

## üîß Configuration

### Environment Variables

Create a `.env` file with:

```env
# Gmail OAuth Credentials
GMAIL_CLIENT_ID=your_client_id
GMAIL_CLIENT_SECRET=your_client_secret
GMAIL_REDIRECT_URI=http://localhost:3000/oauth/callback

# Google Auth Token (generated by npm run setup)
GOOGLE_TOKEN_JSON='{"type":"authorized_user",...}'

# OpenAI Configuration
OPENAI_API_KEY=your_openai_api_key
OPENAI_MODEL=gpt-4o-mini

# Processing Configuration
PROCESSING_INTERVAL_MINUTES=5
LOG_LEVEL=info
```

### Email Filtering Rules

Edit `config/rules.json` to define which emails should get auto-replies:

```json
{
  "rules": [
    {
      "id": "pricing_inquiry",
      "name": "Pricing Request Auto-Reply",
      "enabled": true,
      "conditions": {
        "keywords": ["pricing", "cost", "plans"],
        "mustMatch": "any"
      },
      "context": "Customer is asking about pricing and subscription options"
    }
  ]
}
```

**Rule Properties:**
- `id` - Unique identifier for the rule
- `name` - Human-readable rule name
- `enabled` - Enable/disable without removing
- `conditions.keywords` - Array of keywords to match
- `conditions.mustMatch` - Match strategy: `"any"` or `"all"`
- `context` - Context sent to OpenAI for response generation

---

## üìä Tech Stack

| Component | Technology |
|-----------|-----------|
| Runtime | Node.js |
| Email API | Gmail API |
| AI Generation | OpenAI |
| Scheduling | Node Cron |
| Logging | Winston |
| Language | JavaScript (ES modules) |

---

## üîê Security

### Credential Management

- **OAuth Tokens** - Stored in environment variables, never committed
- **API Keys** - Keep in `.env` file (added to `.gitignore`)
- **Email Data** - Sanitized before sending to OpenAI
- **.env File** - Make sure to add to `.gitignore`

### Best Practices

```bash
# Never commit credentials
echo ".env" >> .gitignore
echo "credentials.json" >> .gitignore

# Use environment variables for sensitive data
export OPENAI_API_KEY="sk-..."
```

---

## üìù Email Response Personalization

The system personalizes responses using:

1. **Sender Information**
   - Full name from email "From" field
   - Company domain from email address
   - Email subject for context

2. **Rule Context**
   - Context description from matching rule
   - Email subject and body

3. **AI Generation**
   - Instructs model to address sender by name
   - Maintains professional tone
   - Keeps responses concise (2-3 sentences)

### Example Flow

```
User email: "Hi, I'm interested in your pricing plans"
                            ‚Üì
Matches rule: "Pricing Request Auto-Reply"
                            ‚Üì
OpenAI generates:
"Hi John, thanks for your interest! Our pricing plans start at $X/month
and include feature Y and Z. Would you like to schedule a demo?"
                            ‚Üì
Reply sent to: user@company.com
```

---

## üìä Monitoring & Logging

### Log Files

Logs are saved to the `logs/` directory:

- `combined.log` - All log messages
- `error.log` - Error messages only

### Real-time Monitoring

```bash
# Watch logs in real-time
tail -f logs/combined.log

# Filter for errors only
tail -f logs/error.log
```

### Log Levels

Set `LOG_LEVEL` in `.env`:

```env
LOG_LEVEL=debug    # Verbose output (development)
LOG_LEVEL=info     # Standard output (default)
LOG_LEVEL=warn     # Warnings and errors only
LOG_LEVEL=error    # Errors only
```

---

## üö® Troubleshooting

### Gmail Credentials Not Found

```bash
npm run setup
```

The system will guide you through OAuth authentication and generate the required token.

### "Starting in degraded mode" message

This means Gmail credentials are missing. The app will start but email processing is disabled. Run `npm run setup` to configure credentials.

### OpenAI API Errors

1. Verify API key is correct:
   ```bash
   echo $OPENAI_API_KEY
   ```

2. Check rate limits in [OpenAI Dashboard](https://platform.openai.com/account/usage)

3. Try a different model:
   ```env
   OPENAI_MODEL=gpt-3.5-turbo  # Lower cost
   ```

### Email Processing Not Working

1. Check logs:
   ```bash
   tail -f logs/combined.log | grep -i error
   ```

2. Verify rules are enabled in `config/rules.json`

3. Test with an email containing keywords from your rules

4. Ensure Gmail API is enabled in Google Cloud Console

### Rate Limiting Issues

If you hit OpenAI rate limits:

1. Increase processing interval:
   ```env
   PROCESSING_INTERVAL_MINUTES=15
   ```

2. Use a lower-cost model:
   ```env
   OPENAI_MODEL=gpt-3.5-turbo
   ```

3. Monitor usage in [OpenAI Dashboard](https://platform.openai.com/usage)

---

## üí∞ Cost Management

### OpenAI Pricing

- **gpt-4o-mini**: ~$0.15 per 1000 emails
- **gpt-3.5-turbo**: ~$0.05 per 1000 emails
- **Example**: 100 emails/day ‚âà $0.45/month (gpt-4o-mini)

### Reduce Costs

1. Switch to cheaper model:
   ```env
   OPENAI_MODEL=gpt-3.5-turbo
   ```

2. Process less frequently:
   ```env
   PROCESSING_INTERVAL_MINUTES=30
   ```

3. Add more specific rules to filter fewer emails

### Free Resources

- Gmail API: Free (within quota limits)
- Node.js: Free and open source

---

## üîß Advanced Configuration

### Hot-Reloading Rules

Modify rules without restarting:

```javascript
import { reloadRules } from './src/filters/engine.js';
reloadRules(); // Reloads rules.json
```

### Custom Response Logic

Edit `src/processor/emailProcessor.js` to customize:
- Response generation logic
- Email filtering criteria
- Post-processing steps

### Batch Processing

Process multiple emails at once:

```javascript
import { processUnreadEmails } from './src/processor/emailProcessor.js';

const results = await processUnreadEmails(10);
console.log(`Processed: ${results.length} emails`);
```

### Database Integration

For email history tracking, add SQLite:

```bash
npm install better-sqlite3
```

---

## üìö Use Cases

- **Customer Support** - Auto-reply to common questions
- **Lead Response** - Acknowledge inquiry requests automatically
- **Business Automation** - Handle routine email workflows
- **CRM Integration** - Automatically update customer records
- **Notification Processing** - Filter and respond to alerts

---

## ü§ù Contributing

To extend the system:

1. **Add filtering rules** - Edit `config/rules.json`
2. **Customize AI responses** - Modify `src/ai/openai.js`
3. **Extend email operations** - Update `src/gmail/emailService.js`
4. **Add new features** - Create modules in `src/`

---

## ‚ö†Ô∏è Important Disclaimers

- **Testing** - Always test with a limited set of emails first
- **Review** - Review generated responses before enabling to customers
- **Monitoring** - Monitor regularly to ensure response quality
- **Compliance** - Comply with email regulations (CAN-SPAM, GDPR, etc.)
- **Liability** - Emails are sent automatically; ensure proper safeguards

---

## üìÑ License

MIT

---

## üë®‚Äçüíª Author

**Hammad Khan**
Automation Engineer
GitHub: [@khanmadham](https://github.com/khanmadham)

---

## üìû Support

For issues and questions:
- Check the [Troubleshooting](#-troubleshooting) section
- Review logs in `logs/` directory
- Enable debug logging with `LOG_LEVEL=debug`
